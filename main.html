<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Ubicaciones Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen py-12 px-4 font-sans">

    <div class="max-w-2xl mx-auto bg-white shadow-sm border border-gray-200 rounded-xl p-8">
        <header class="mb-8 text-center">
            <h2 class="text-2xl font-bold text-gray-800">Gestión de Cuentas</h2>
            <p class="text-sm text-gray-500 mt-1">Seleccione una ubicación y asigne contactos.</p>
        </header>
        
        <form id="mainForm" class="space-y-6">
            <div class="relative">
                <label class="block text-xs font-semibold uppercase tracking-wider text-gray-400 mb-2">Cuenta / Ubicación</label>
                <div class="relative">
                    <input type="text" id="searchAccount" placeholder="Escriba para buscar ubicación..." autocomplete="off"
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all text-gray-700">
                    
                    <div id="resultsList" class="absolute z-20 w-full bg-white border border-gray-200 rounded-lg mt-1 max-h-64 overflow-y-auto hidden shadow-xl"></div>
                </div>
                
                <input type="hidden" id="selectedAccountName">
                <input type="hidden" id="selectedLocationId">
                <input type="hidden" id="selectedCompanyId">
                
                <p id="selectedFeedback" class="text-xs text-blue-600 mt-2 font-medium min-h-[1.25rem] italic"></p>
            </div>

            <div class="border-t border-gray-100 pt-6">
                <div id="peopleContainer" class="space-y-4">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-400">Contactos</h3>
                        <button type="button" id="addPerson" class="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 transition-colors">
                            <span class="text-lg">+</span> AÑADIR PERSONA
                        </button>
                    </div>

                    <div class="person-entry grid grid-cols-1 md:grid-cols-3 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200 relative group">
                        <div class="space-y-1">
                            <input type="text" placeholder="Nombre" name="first_name" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-400">
                        </div>
                        <div class="space-y-1">
                            <input type="text" placeholder="Apellido" name="last_name" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-400">
                        </div>
                        <div class="space-y-1">
                            <input type="email" placeholder="Email" name="email" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-400">
                        </div>
                    </div>
                </div>
            </div>

            <button type="submit" id="submitBtn" class="w-full bg-gray-900 hover:bg-black text-white font-semibold py-4 rounded-lg transition-all shadow-md flex justify-center items-center mt-8">
                <span>Enviar y Procesar</span>
                <div id="spinner" class="hidden loader rounded-full border-2 border-t-2 border-white h-5 w-5 ml-3"></div>
            </button>
        </form>

        <div id="statusMsg" class="mt-4 text-center text-sm font-medium hidden"></div>
    </div>

    <script>
        const GET_WEBHOOK_URL = 'https://hook.us2.make.com/3dsfptf2s4bseiwaozr3bumfk5guw58z';
        const POST_WEBHOOK_URL = 'https://hook.us2.make.com/6czd9m1i7uqqnbnizn8lkokrlcgrs9zl';

        let locationsData = [];
        
        // Elementos DOM
        const searchInput = document.getElementById('searchAccount');
        const resultsList = document.getElementById('resultsList');
        const hiddenName = document.getElementById('selectedAccountName');
        const hiddenLocId = document.getElementById('selectedLocationId');
        const hiddenCompId = document.getElementById('selectedCompanyId');
        const feedback = document.getElementById('selectedFeedback');
        const peopleContainer = document.getElementById('peopleContainer');
        const addPersonBtn = document.getElementById('addPerson');

        // 1. Obtener datos iniciales
        async function loadData() {
            try {
                const response = await fetch(GET_WEBHOOK_URL);
                const data = await response.json();
                // Navegamos la estructura: data[0] -> body -> locations
                locationsData = data[0].body.locations;
            } catch (e) {
                searchInput.placeholder = "Error al conectar con el servidor...";
            }
        }

        // 2. Buscador con guardado de IDs
        searchInput.addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            resultsList.innerHTML = '';
            
            if (val.length < 1) {
                resultsList.classList.add('hidden');
                return;
            }

            const filtered = locationsData.filter(item => item.name.toLowerCase().includes(val));

            if (filtered.length > 0) {
                resultsList.classList.remove('hidden');
                filtered.forEach(item => {
                    const row = document.createElement('div');
                    row.className = "px-4 py-3 hover:bg-gray-50 cursor-pointer text-sm border-b border-gray-100 last:border-0";
                    row.innerHTML = `<strong>${item.name}</strong> <span class="text-xs text-gray-400 ml-2">ID: ${item.id}</span>`;
                    
                    row.onclick = () => {
                        // Guardar toda la metadata necesaria
                        searchInput.value = item.name;
                        hiddenName.value = item.name;
                        hiddenLocId.value = item.id;
                        hiddenCompId.value = item.companyId;
                        
                        feedback.textContent = `✓ Seleccionado: ${item.name} (Loc: ${item.id})`;
                        resultsList.classList.add('hidden');
                    };
                    resultsList.appendChild(row);
                });
            } else {
                resultsList.classList.add('hidden');
            }
        });

        // 3. Agregar/Remover Contactos
        addPersonBtn.addEventListener('click', () => {
            const div = document.createElement('div');
            div.className = "person-entry grid grid-cols-1 md:grid-cols-3 gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200 relative group animate-fade-in";
            div.innerHTML = `
                <input type="text" placeholder="Nombre" name="first_name" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-400">
                <input type="text" placeholder="Apellido" name="last_name" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-400">
                <input type="email" placeholder="Email" name="email" required class="w-full border border-gray-300 rounded px-3 py-2 text-sm outline-none focus:border-blue-400">
                <button type="button" class="remove-btn absolute -right-2 -top-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-all shadow-sm">×</button>
            `;
            peopleContainer.appendChild(div);
            div.querySelector('.remove-btn').onclick = () => div.remove();
        });

        // 4. Submit final
        document.getElementById('mainForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!hiddenLocId.value) {
                alert("Por favor selecciona una ubicación de la lista desplegable.");
                return;
            }

            const btn = document.getElementById('submitBtn');
            const spinner = document.getElementById('spinner');
            const status = document.getElementById('statusMsg');

            // Mapeo de personas
            const contacts = Array.from(document.querySelectorAll('.person-entry')).map(p => ({
                first_name: p.querySelector('[name="first_name"]').value,
                last_name: p.querySelector('[name="last_name"]').value,
                email: p.querySelector('[name="email"]').value
            }));

            // JSON Final solicitado
            const dataToSend = {
                location_id: hiddenLocId.value,
                company_id: hiddenCompId.value,
                account_name: hiddenName.value,
                contacts: contacts
            };

            btn.disabled = true;
            spinner.classList.remove('hidden');

            try {
                const response = await fetch(POST_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSend)
                });

                if (response.ok) {
                    status.innerHTML = "✓ Información enviada correctamente";
                    status.className = "mt-4 text-center text-sm font-bold text-green-600 block";
                    document.getElementById('mainForm').reset();
                    feedback.textContent = "";
                    // Reset hidden fields
                    [hiddenName, hiddenLocId, hiddenCompId].forEach(h => h.value = "");
                } else { throw new Error(); }
            } catch (err) {
                status.innerHTML = "✕ Error al procesar el envío";
                status.className = "mt-4 text-center text-sm font-bold text-red-600 block";
            } finally {
                btn.disabled = false;
                spinner.classList.add('hidden');
            }
        });

        // Clic fuera cierra lista
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target)) resultsList.classList.add('hidden');
        });

        loadData();
    </script>
</body>
</html>
